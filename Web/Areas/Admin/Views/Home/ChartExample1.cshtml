
@{
    Layout = "";
}
<div>
    <div>
        <textarea id="code" style="width: 100%;" rows="11">
st=>start: Start:>http://www.google.com[blank]
e=>end:>http://www.google.com
op1=>operation: My Operation
sub1=>subroutine: My Subroutine
cond=>condition: Yes
or No?:>http://www.google.com
io=>inputoutput: catch something...
para=>parallel: parallel tasks

st->op1->cond
cond(yes)->io->e
cond(no)->para
para(path1, bottom)->sub1(right)->op1
para(path2, top)->op1
    </textarea>
    </div>
    <div><button id="run" type="button">Run</button></div>
    <div id="canvas"></div>
</div>
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel4" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel4">Thông tin</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body pt-0 pb-0">
                <div class="row mt-2">
                    <div class="col-md-12">
                        <div class="media bg-white d-flex my-2">
                            <div class="media-left media-middle">
                                <a href="#" id="link-node" target="blank">
                                    <img class="media-object" id="img-node" src="" alt="">
                                </a>
                            </div>
                            <div class="media-body friend-elipsis">
                                <div class="f-15 f-bold m-b-5">Tên quy trình: <span id="name-node"></span></div>
                                <input type="hidden" id="EmployeeIdSearch" value="" />
                                <div class="text-muted social-designation">Mã quy trình: <span id="id-node"></span></div>
                                <div class="text-muted social-designation">Người tiếp nhận: <span id="job-node"></span></div>
                                <div class="text-muted social-designation">Số điện thoại: <span id="phone-node"></span></div>
                                <div class="text-muted social-designation">Email: <span id="mail-node"></span></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<style type="text/css">
    .end-element {
        fill: #dc3c00;
    }

    .start-element {
        fill: #0516ff;
    }
    .info {
        fill: blue;
    }
    .success {
        fill: green;
    }
    .success-t {
        fill: red;
    }
    .cancel {
        fill: purple;
    }
    .danger {
        fill: red;
    }
    .warning {
        fill: yellow;
    }
    .media-object {
        width: 70px !important;
        height: 70px !important;
        border-radius: 100%;
    }
</style>
<script>
    var obj = {
        objList: [
            {
                "Status": "1",
                "StepCode": "st",
                "StepName": "Bắt đầu",
                "StepColor": "Primary",
                "StepLink": "http://www.google.com",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "start",
            },
            {
                "Status": "2",
                "StepCode": "e",
                "StepName": "Kết thúc",
                "StepColor": "",
                "StepLink": "",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "end",
            },
            {
                "Status": "3",
                "StepCode": "op1",
                "StepName": "My Operation",
                "StepColor": "",
                "StepLink": "",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "operation",
            },
            {
                "Status": "4",
                "StepCode": "sub1",
                "StepName": "My Subroutine",
                "StepColor": "",
                "StepLink": "",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "subroutine",
            },
            {
                "Status": "5",
                "StepCode": "cond",
                "StepName": "Yes or No?",
                "StepColor": "",
                "StepLink": "http://www.google.com",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "condition",
            },
            {
                "Status": "1",
                "StepCode": "io",
                "StepName": "catch something...",
                "StepColor": "",
                "StepLink": "",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "inputoutput",
            },
            {
                "Status": "2",
                "StepCode": "para",
                "StepName": "parallel tasks",
                "StepColor": "",
                "StepLink": "",
                "Description": {
                    "Image": "/Content/Templates/GuruTemplate/assets/images/fpt.png",
                    "Name": "Xử lý lỗi",
                    "Note": "Ghi chú",
                    "Id": '32324',
                    "Phone": '0909022365',
                    "Job": "Nguyễn Văn A",
                    "Mail": "hoang@fpt.com.vn",
                    "Link": "https://www.google.com/",
                },
                "DescriptionViewType": "Toolltip",
                "StepType": "parallel",
            },
        ],
        conection: [
            {
                "StepFrom": "st",
                "StepTo": "op1",
                "CondAction": "",
                // "Caption": "Đồng ý",
                "DirectionsStep": "",//  ---"left,top,right,down,''"
                "StepType": "start",
            },
            {
                "StepFrom": "op1",
                "StepTo": "cond",
                "CondAction": "",
                "DirectionsStep": "",
                "StepType": "operation",
            },
            {
                "StepFrom": "cond",
                "StepTo": "io",
                "CondAction": "yes",
                "DirectionsStep": "",
                "StepType": "condition",
            },
            {
                "StepFrom": "io",
                "StepTo": "e",
                "CondAction": "",
                "DirectionsStep": "",
                "StepType": "inputoutput",
            },
            {
                "StepFrom": "cond",
                "StepTo": "para",
                "CondAction": "no",
                "DirectionsStep": "",
                "StepType": "condition",
            },
            {
                "StepFrom": "para",
                "StepTo": "sub1",
                "CondAction": "",
                "DirectionsStep": "bottom",
                "StepType": "parallel",
            },
            {
                "StepFrom": "sub1",
                "StepTo": "op1",
                "CondAction": "",
                "DirectionsStep": "right",
                "StepType": "subroutine",
            },
            {
                "StepFrom": "para",
                "StepTo": "op1",
                "CondAction": "",
                "DirectionsStep": "top",
                "StepType": "parallel",
            },
        ],
    };
    function clickNode(i) {
        console.log(obj.objList[i]);
        $('#exampleModal').modal('toggle');
        $('#img-node').attr("src", obj.objList[i].Description.Image);
        $('#name-node').text(obj.objList[i].Description.Name);
        $('#id-node').text(obj.objList[i].Description.Id);
        $('#phone-node').text(obj.objList[i].Description.Phone);
        $('#job-node').text(obj.objList[i].Description.Job);
        $('#mail-node').text(obj.objList[i].Description.Mail);
        $("#link-node").attr("href", obj.objList[i].Description.Link);
    }
    var btn = document.getElementById("run"),
        cd = document.getElementById("code"),
        chart;

    (btn.onclick = function () {
        var code = cd.value;
        if (chart) {
            chart.clean();
        }
        var data = '';
        if (obj && obj.objList && obj.conection) {
            for (var i = 0; i < obj.objList.length; i++) {
                var text = '';
                text += obj.objList[i].StepCode;
                text += '=>';
                text += obj.objList[i].StepType;
                text += ': ';
                text += obj.objList[i].StepName;
                text += ':>';
                text += 'javascript:clickNode(' + i + ')';
                // if (obj.objList[i].StepLink) {
                //     text += ':>';
                //     text += obj.objList[i].StepLink;
                //     text += '[blank]';
                // }
                text += '\n';
                data += text;
            }
            data += '\n';
            var pathNumber = 1;
            for (var i = 0; i < obj.conection.length; i++) {
                var text = '';
                text += obj.conection[i].StepFrom;
                if (obj.conection[i].StepType == 'condition') {
                    text += "(" + obj.conection[i].CondAction + ")";
                } else if (obj.conection[i].StepType == 'parallel') {
                    text += "(path" + pathNumber;
                    pathNumber += 1;
                    if (obj.conection[i].StepType) {
                        text += ", " + obj.conection[i].DirectionsStep + ")";
                    }
                } else if (obj.conection[i].StepType == 'subroutine') {
                    text += "(" + obj.conection[i].DirectionsStep + ")";
                }
                text += '->';
                text += obj.conection[i].StepTo;
                text += '\n';
                data += text;
            }
        }
        chart = flowchart.parse(data);
        chart.drawSVG('canvas', {
            // 'x': 30,
            // 'y': 50,
            'line-width': 3,
            'maxWidth': 3,//ensures the flowcharts fits within a certian width
            'line-length': 50,
            'text-margin': 10,
            'font-size': 16,
            'font': 'normal',
            'font-family': 'Helvetica',
            'font-weight': 'normal',
            'font-color': 'black',
            'line-color': '#00dadc',
            'element-color': 'white',
            'fill': 'white',
            'yes-text': 'yes',
            'no-text': 'no',
            'arrow-end': 'block',
            'scale': 1,
            'symbols': {
                'start': {
                    'font-color': 'white',
                    'element-color': 'white',
                    'class': 'start-element',
                },
                'end': {
                    'font-color': 'white',
                    'class': 'end-element',
                    'element-color': 'white',
                }
            },
            'flowstate': {
                'past': { 'fill': '#CCCCCC', 'font-size': 12 },
                'current': { 'fill': 'yellow', 'font-color': 'red', 'font-weight': 'bold' },
                'future': { 'fill': '#79C900', 'font-color': 'white' },
                'request': { 'fill': '#79C900' },
                'invalid': { 'fill': '#444444' },
                'approved': { 'fill': '#58C4A3', 'font-size': 12, 'yes-text': 'APPROVED', 'no-text': 'n/a' },
                'rejected': { 'fill': '#C45879', 'font-size': 12, 'yes-text': 'n/a', 'no-text': 'REJECTED' }
            }
        });
        for (var i = 0; i < obj.objList.length; i++) {
            if (obj.objList[i] && obj.objList[i].Status) {
                if (obj.objList[i].Status == "1") {
                    $('#' + obj.objList[i].StepCode).addClass('info');
                } else if (obj.objList[i].Status == "2") {
                    $('#' + obj.objList[i].StepCode).addClass('success');
                    $('#' + obj.objList[i].StepCode + 't').addClass('success-t');
                } else if (obj.objList[i].Status == "3") {
                    $('#' + obj.objList[i].StepCode).addClass('cancel');
                } else if (obj.objList[i].Status == "4") {
                    $('#' + obj.objList[i].StepCode).addClass('danger');
                } else if (obj.objList[i].Status == "5") {
                    $('#' + obj.objList[i].StepCode).addClass('warning');
                }
            }
        }
        // $('[id^=sub1]').click(function () {
        //     alert('info here');
        // });
    })();

    function myFunction(event, node) {
        console.log("You just clicked this node:", node);
    }

</script>